#include<Windows.h>
#include <iostream>

void _declspec(naked) hashcode() {
	__asm {
		push ebp
		mov ebp,esp
		sub esp,0xc
		push esi
		push ebx
		push ecx
		push edx
		mov dword ptr [ebp-0x4],0

		//循环准备阶段
		mov esi, [ebp + 0x8] //strname地址
		xor eax, eax //eax清零
		xor ecx,ecx
	tag_loop:
		mov al, [esi + ecx] //获取第ecx个字符
		test al, al //检查是否为字符串结束符
		jz tag_out_loop //如果是字符串结束符则跳出循环
		mov ebx, [ebp - 0x4]
		shl ebx, 0x19 //左移25位
		mov edx, [ebp-0x4]
		shr edx, 0x7 //右移7位
		or ebx,edx
		add ebx, eax //加上第一个字符
		mov[ebp - 0x4], ebx //保存到[ebp - 0x4]
		inc ecx
		jmp tag_loop //继续循环
	tag_out_loop:
		mov eax,[ebp - 0x4]
		pop edx
		pop ecx
		pop ebx
		pop esi
		mov esp, ebp
		pop ebp
		retn 0x4
	}
}

DWORD getHashCode(char* strname)
{
	DWORD digest = 0;
	while (*strname)
	{
		digest = (digest << 25 | digest >> 7);
		digest = digest + *strname;
		strname++;
	}
	return digest;
}

int main() {
	char strname[] = "LoadLibraryA";
	
	//__asm {
	//	lea eax, strname
	//	push eax
	//	call hashcode
	//}
	DWORD hash = getHashCode(strname);
	// c917432
	printf("%s, hash: %x\n", strname, hash);

	//LoadLibraryA, hash: c917432
	// MessageBoxA, hash: 1e380a6a
	char strname2[] = "MessageBoxA";
	DWORD hash2 = getHashCode(strname2);
	printf("%s, hash: %x\n", strname2, hash2);

	char strname3[] = "ExitProcess";
	DWORD hash3 = getHashCode(strname3);
	printf("%s, hash: %x\n", strname3, hash3);

	delete[] strname;
	delete[] strname2;
	delete[] strname3;

	return 0;
}